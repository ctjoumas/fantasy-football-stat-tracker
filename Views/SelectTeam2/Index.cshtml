@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Index</title>
    <style>
        /* The Modal (background) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            padding-top: 100px; /* Location of the box */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content */
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 20%;
            color: darkblue;
            text-align: center;
            font-weight: bold;
        }

        /* The Close Button */
        .close {
            background-color: darkblue;
            border: none;
            color: white;
            padding: 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <table style="border-collapse:inherit;margin: 0;margin-left: auto;margin-right: auto;float: none;width: 50%;vertical-align: middle;padding: 2px;border-spacing: 20px;">
        <tr>
            <td style="text-align: left; width:50%;">Search for player:</td>
            <td style="text-align: left; width:50%;">Selected Team:</td>
        </tr>
        <tr>
            <td style="vertical-align: top;">
                <input id="txtPlayerName" type="text" style="width:98%;" autocomplete="off" />
                <br />
                <select id="filteredPlayerList" class="js-example-basic-single" style="width: 100%;display: none;" size="1">
                </select>
            </td>
            <td style="vertical-align: top;">
                <select id="selectedPlayerList" style="width: 100%;" size="9"></select>
            </td>
        </tr>
        <tr>
            <td></td>
            <td style="text-align: right;border-collapse:inherit;margin: 0;display:block;float:none;">
                <input id="btnRemove" type="button" value="Remove" />
            </td>
        </tr>
        <tr>
            <td></td>
            <td style="text-align: right;border-collapse:inherit;margin: 0;display:block;float:none;">
                <input id="btnSubmit" type="submit" value="Submit" />
            </td>
        </tr>
    </table>

    <!-- The Modal -->
    <div id="myModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <p>Invalid roster.</p>
            <div style="color:black; font-weight: normal;">Please enter a valid roster</div>
            <br />
            <!--span class="close"-->
                <button class="close" id="closeBtn">Close</button>
            <!--/span-->
        </div>
    </div>

    <script type="text/javascript">
        $(document).ready(function () {
            //$('.js-example-basic-single').select2();

            // load the initial list of all players, which will be stored into a cached session variable
            GetPlayers();

            $("#txtPlayerName").keyup(delay(function (e) {
                GetPlayers();
            }, 300));

            // handle when a player is selected
            $("#filteredPlayerList").on('change', function () {
                var filteredPlayerList = $("#filteredPlayerList");
                var selectedPlayerList = $("#selectedPlayerList");

                var selectedItem = $('#filteredPlayerList option:selected');

                selectedPlayerList.append('<option value="' + selectedItem.val() + '">' + selectedItem.text() + '</option>');

                // expand the dropdown list
                var event = document.createEvent('MouseEvents');
                event.initMouseEvent('mousedown', true, true, window);

                // clear search text and the list of players
                $("#txtPlayerName").val('');
                $("#txtPlayerName").focus();
                filteredPlayerList.empty();
                $('#filteredPlayerList').css("width", "100%");
                filteredPlayerList.hide();
            });

            // handle when a player is removed
            $('#btnRemove').click(function (e) {
                $('#selectedPlayerList option:selected').remove();
            });
        });
        function GetPlayers() {
            var name = $("#txtPlayerName").val();

            // get all selected players and remove this from the returned filter so they cannot be selected again
            var selectedPlayers = $('#selectedPlayerList option');
            var selectedPlayerIds = $.map(selectedPlayers, function (option) {
                return option.value;
            });

            $.ajax({
                type: "POST",
                url: "@Url.Action("SearchPlayers")",
                data: { playerName: name, selectedPlayerIds: selectedPlayerIds },
                dataType: "json",
                success: function (players) {

                    // only populate and fill the filtered player list if there is at least one player returned
                    if (players.length > 0) {

                        // clear the filtered player list before adding players
                        var filteredPlayerList = $("#filteredPlayerList");
                        filteredPlayerList.empty();

                        $.each(players, function (i, player) {
                            $(filteredPlayerList).append('<option value="' + player.espnPlayerId + '">' + player.playerName + ' ' + player.position + '</option>');
                        });

                        filteredPlayerList.show();

                        // expand the dropdown list
                        var event = document.createEvent('MouseEvents');
                        event.initMouseEvent('mousedown', true, true, window);
                        $(filteredPlayerList).attr("size", $("#filteredPlayerList option").length+1);
                    }
                }
            });
        }
        $('#btnSubmit').click(function (e) {
            // get all selected players and remove this from the returned filter so they cannot be selected again
            var selectedPlayers = $('#selectedPlayerList option');
            var selectedPlayerIds = $.map(selectedPlayers, function (option) {
                return option.value;
            });

            e.preventDefault();
            var element = this;
            $.ajax({
                type: "POST",
                url: "@Url.Action("SaveRoster")",
                data: { week: @ViewData["Week"], ownerId: @ViewData["OwnerId"], selectedPlayerIds: selectedPlayerIds },
                dataType: "json",
                success: function (response) {
                    if (response.result == true) {
                        $(element).closest("form").submit();
                        window.location = response.redirectUrl;
                    }
                    else {
                        //document.getElementById('error-message').innerHTML = response.error;
                        // get the modal
                        var modal = document.getElementById("myModal");

                        // get the span element that closes the modal
                        var span = document.getElementsByClassName("close")[0];

                        // open the modal
                        modal.style.display = "block";

                        // when the user clicks on span (x), close the modal
                        span.onclick = function () {
                            modal.style.display = "none";
                        }

                        // when the user clicks anywhere outside of the modal, close it
                        /*window.onclick = function (event) {
                            if (event.target == modal) {
                                modal.style.display = "none";
                            }
                        }*/
                    }
                },
            });
        });
        function delay(fn, ms) {
            let timer = 0
            return function (...args) {
                clearTimeout(timer)
                timer = setTimeout(fn.bind(this, ...args), ms || 0)
            }
        }
    </script>
</body>
</html>